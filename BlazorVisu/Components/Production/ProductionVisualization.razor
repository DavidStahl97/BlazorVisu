@using BlazorVisu.Models
@using Radzen
@using Radzen.Blazor

<svg viewBox="0 0 1000 600" class="production-svg">

        <!-- Machine -->
        <g class="station machine" transform="translate(50, 200)">
            <!-- Shadow -->
            <rect width="120" height="80" rx="4" x="2" y="2"
                  fill="rgba(0,0,0,0.1)"/>
            <!-- Main button -->
            <rect width="120" height="80" rx="4"
                  fill="@GetStatusColor(ProductionData.Machine.Status)"
                  stroke="@GetBorderColor(ProductionData.Machine.Status)" stroke-width="1"/>
            <text x="60" y="45" text-anchor="middle" class="station-text">Machine</text>

            <!-- Production indicator -->
            @if (ProductionData.Machine.Status == StationStatus.Running)
            {
                <circle cx="105" cy="12" r="4" fill="white">
                    <animate attributeName="opacity" values="1;0.3;1" dur="1s" repeatCount="indefinite"/>
                </circle>
            }
        </g>

        <!-- Switch/Weiche -->
        <g class="station switch" transform="translate(400, 200)">
            <!-- Shadow -->
            <rect width="80" height="80" rx="4" x="2" y="2"
                  fill="rgba(0,0,0,0.1)"/>
            <!-- Main button -->
            <rect width="80" height="80" rx="4"
                  fill="@GetStatusColor(ProductionData.Switch.Status)"
                  stroke="@GetBorderColor(ProductionData.Switch.Status)" stroke-width="1"/>
            <text x="40" y="45" text-anchor="middle" class="station-text">Switch</text>

            @if (ProductionData.Switch.Status == StationStatus.Running)
            {
                <circle cx="65" cy="15" r="3" fill="white">
                    <animate attributeName="opacity" values="1;0.3;1" dur="0.8s" repeatCount="indefinite"/>
                </circle>
            }
        </g>

        <!-- Consumers -->
        @for (int i = 0; i < ProductionData.Consumers.Count; i++)
        {
            var consumer = ProductionData.Consumers[i];
            var yPosition = 100 + (i * 150);

            <g class="station consumer" transform="translate(750, @yPosition)">
                <!-- Shadow -->
                <rect width="120" height="80" rx="4" x="2" y="2"
                      fill="rgba(0,0,0,0.1)"/>
                <!-- Main button -->
                <rect width="120" height="80" rx="4"
                      fill="@GetStatusColor(consumer.Status)"
                      stroke="@GetBorderColor(consumer.Status)" stroke-width="1"/>
                <text x="60" y="45" text-anchor="middle" class="station-text">Consumer @(i+1)</text>


                @if (consumer.Status == StationStatus.Running)
                {
                    <circle cx="105" cy="12" r="4" fill="white">
                        <animate attributeName="opacity" values="1;0.3;1" dur="1.2s" repeatCount="indefinite"/>
                    </circle>
                }
            </g>
        }

        <!-- Connection Lines -->
        <!-- Machine to Switch -->
        <line x1="170" y1="240" x2="400" y2="240"
              stroke="#666" stroke-width="3" stroke-dasharray="5,5">
            <animate attributeName="stroke-dashoffset" values="10;0" dur="1s" repeatCount="indefinite"/>
        </line>

        <!-- Switch to Consumers -->
        @for (int i = 0; i < ProductionData.Consumers.Count; i++)
        {
            var yPosition = 140 + (i * 150);
            <line x1="480" y1="240" x2="750" y2="@yPosition"
                  stroke="#666" stroke-width="2" stroke-dasharray="3,3">
                <animate attributeName="stroke-dashoffset" values="6;0" dur="0.8s" repeatCount="indefinite"/>
            </line>
        }

        <!-- Animated Components in Transit -->
        @foreach (var component in ComponentsInTransit)
        {
            <circle r="8" fill="@GetComponentColor(component.Type)" stroke="#333" stroke-width="2">
                <animateMotion dur="3s" repeatCount="indefinite"
                               path="@GetComponentPath(component)"/>
            </circle>
        }

</svg>

<style>
    body, html {
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
    }

    * {
        box-sizing: border-box;
    }

    .rz-layout, .rz-body, .rz-content-container, .main {
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
    }

    .production-svg {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
    }

    .station-text {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        font-weight: 500;
        fill: white;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }


    .station {
        /* No hover effects or cursor pointer - static display */
    }
</style>

@code {
    [Parameter] public ProductionSystem ProductionData { get; set; } = new();

    private List<Component> ComponentsInTransit => ProductionData.ComponentsInTransit;

    private string GetStatusColor(StationStatus status) => status switch
    {
        StationStatus.Running => "#4caf50",     // Material Green
        StationStatus.Stopped => "#ff9800",     // Material Orange
        StationStatus.Error => "#f44336",       // Material Red
        StationStatus.Maintenance => "#2196f3", // Material Blue
        _ => "#9e9e9e"                          // Material Gray
    };

    private string GetBorderColor(StationStatus status) => status switch
    {
        StationStatus.Running => "#388e3c",     // Darker Green
        StationStatus.Stopped => "#f57c00",     // Darker Orange
        StationStatus.Error => "#d32f2f",       // Darker Red
        StationStatus.Maintenance => "#1976d2", // Darker Blue
        _ => "#757575"                          // Darker Gray
    };

    private string GetComponentColor(ComponentType type) => type switch
    {
        ComponentType.TypeA => "#007bff",  // Blue
        ComponentType.TypeB => "#28a745",  // Green
        ComponentType.TypeC => "#dc3545",  // Red
        _ => "#6c757d"                     // Gray
    };

    private string GetComponentPath(Component component)
    {
        // Determine path based on component's journey
        if (component.CurrentStationId == "MACHINE_01")
        {
            return "M 170 240 L 400 240";  // Machine to Switch
        }
        else if (component.CurrentStationId?.StartsWith("CONSUMER") == true)
        {
            var consumerIndex = int.Parse(component.CurrentStationId.Replace("CONSUMER_", "")) - 1;
            var yPosition = 140 + (consumerIndex * 150);
            return $"M 480 240 L 750 {yPosition}";  // Switch to Consumer
        }

        return "M 170 240 L 400 240";  // Default path
    }
}